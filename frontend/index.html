<!DOCTYPE html>
<html>
 <body style="background-color: lightseagreen;">

<head>
    <title>RepeatAfterMe.ai</title>
    <style>
        body {
            background-color: lightseagreen;
        }
    </style>
</head>
<body>
    <h1>RepeatAfterMe.ai</h1>
    <hr>
    <h2>Word:</h2> {{ word }}

    <h3>Record Audio:</h3>
    <button id="record-btn">Start Recording</button>
    <p id="record-status"></p>

     <audio id="audioPlayer" controls style="display:none;"></audio>


    <h3>Upload File:</h3>
    <form action="/upload" method="POST" enctype="multipart/form-data">
        <!-- Hidden input to send the word with the form -->
        <input type="hidden" name="word" value="{{ word }}">
        <input type="file" name="file" id="fileinput" required> 
        <button type="submit">Submit</button>
    </form>
    <hr>
    <h3>Results:</h3>
    {% if result %}
        <p><strong>Transcribed Text:</strong> {{ result.transcription }}</p>
        <p><strong>Pronunciation Score:</strong> {{ result.score }}</p>
    {% else %}
        <p>No results yet. Upload a file and try.</p>
    {% endif %}

<script>
const recordBtn = document.getElementById('record-btn');
const status = document.getElementById('record-status');
const fileInput = document.getElementById('fileinput');
const audioPlayer = document.getElementById('audioPlayer');
const submitBtn = document.getElementById('submit-btn');
let recorder, chunks;

recordBtn.onclick = async () => {
if (recordBtn.textContent === 'Start Recording') {
    try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.start();
    recordBtn.textContent = 'Stop Recording';
    status.textContent = 'Recording...';
    submitBtn.disabled = true;
    audioPlayer.style.display = 'none';
    audioPlayer.src = '';
    } catch (e) {
        console.warn('Microphone access denied or not available.');
    }
} else {
    recorder.stop();
    recordBtn.textContent = 'Start Recording';
    status.textContent = 'Processing audio...';

    recorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'audio/mp3' });
    const audioURL = URL.createObjectURL(blob);
    audioPlayer.src = audioURL;
    audioPlayer.style.display = 'block';
    status.textContent = 'Recording ready to upload. Submit the form.';

    // Convert Blob to a File object and set it to the hidden file input
    const file = new File([blob], 'recording.mp3', { type: 'audio/mp3' });
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    fileInput.files = dataTransfer.files;

    submitBtn.disabled = false;
    };
}
};
</script>

</body>
</html>
